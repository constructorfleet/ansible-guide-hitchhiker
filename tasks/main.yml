---

- name: Deploy/Update a Home-Assistant integration
  import_tasks: homeassistant.yml
  when:
    - (hitchhiker_type | lower) == 'homeassistant'

- name: Create/Set-up docker networks and containers
  include_role:
    name: docker

- name: Restart container if needed
  systemd:
    name: "docker-hitchhiker_{{ hitchhiker_config.name }}"
    state: restarted
  when:
    - docker_service is not changed
    - customization_file is changed or configuration_file is changed

- name: Wait for container to start
  wait_for:
    host: '{{ ansible_fqdn }}'
    port: '{{ homeassistant_port | int }}'
    timeout: 45

- name: Set homeassistant_url fact
  set_fact:
    homeassistant_url: '{{ hitchhiker_uri_scheme }}://{{ ansible_fqdn }}:{{ homeassistant_port }}'
    homeassistant_url_schemeless: '{{ ansible_fqdn }}:{{ homeassistant_port }}'

- name: Set user creation payload fact
  set_fact:
    create_user_payload:
      client_id: "{{ homeassistant_url }}/"
      name: "{{ homeassistant_name | default('admin')}}"
      username: "{{ homeassistant_username | default('admin')}}"
      password: "{{ homeassistant_password }}"
      language: en

- name: Create Home-Assistant admin user
  uri:
    url: '{{ homeassistant_url }}/api/onboarding/users'
    method: POST
    headers:
      Host: "{{ homeassistant_url_schemeless }}"
      Origin: "{{ homeassistant_url_schemeless }}"
    body_format: raw
    body: '{{ create_user_payload | to_json }}'
    return_content: yes
  register: user_onboarding

- name: Set authorization code fact
  set_fact:
    authorization_code: '{{ user_onboarding.content | regex_replace(auth_code_regex, "\\1") }}'

- name: Set token creation payload fact
  set_fact:
    token_creation_payload:
      client_id: "{{ homeassistant_url }}/"
      code: '{{ authorization_code }}'
      grant_type: authorization_code

- name: Get refresh token for admin user
  uri:
    url: '{{ homeassistant_url }}/api/auth/token'
    method: POST
    headers:
      Host: "{{ homeassistant_url_schemeless }}"
      Origin: "{{ homeassistant_url_schemeless }}"
    body_format: raw
    body: "{{ token_creation_payload | to_json }}"
    return_content: yes
  register: refresh_token

- debug:
    var: refresh_token





